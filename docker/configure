#!/bin/sh

cd "$(dirname "$(readlink -f "$0")")"

envTarget='sslh.env'
portPattern='[1-9][0-9]{0,4}'

function readValue { # prompt, default, variable, pattern
	[[ -f "$envTarget" ]] && current="$(grep "^# $1: " "$envTarget" | cut -d' ' -f4)" || current=""
	read -p "$1: " -i "${current:-$2}" -e $3
	value="$(echo "${!3}" | egrep "^${4:-.+}$")"
	[[ -z "$value" ]] && echo "Invalid value: \"${!3}\"" >&2 && exit 1
}

readValue 'Listening port' '44322' listeningPort "$portPattern"
readValue 'SSH host' '127.0.0.1' sshHost
readValue 'SSH port' '22' sshPort "$portPattern"
readValue 'HTTPS host' '127.0.0.1' httpsHost
readValue 'HTTPS port' '443' httpsPort "$portPattern"

echo

target='docker-compose.yml'
echo "Writing $target..."
cp -f 'docker-compose.template.yml' "$target"

target="$envTarget"
echo "Writing $target..."
echo "# Listening port: $listeningPort" > "$target"
echo "# SSH host: $sshHost" >> "$target"
echo "# SSH port: $sshPort" >> "$target"
echo "# HTTPS host: $httpsHost" >> "$target"
echo "# HTTPS port: $httpsPort" >> "$target"
echo >> "$target"
echo "SSLH_OPTS=-p 0.0.0.0:$listeningPort --ssh $sshHost:$sshPort --tls $httpsHost:$httpsPort" >> "$target"

echo
echo 'Docker Compose configured successfully'
