#!/bin/sh

cd "$(dirname "$(readlink -f "$0")")"

function IsPort {
	local port=$(echo "$1" | grep "^[1-9][0-9]*$")
	if [[ -z "$port" ]]; then
		>&2 echo "$1: invalid port"
		exit 1
	fi
}

[[ -f 'sslh.env' ]] && currentHttpsHost="$(grep '^# HTTPS host: ' 'sslh.env' | cut -d' ' -f4)"
currentHttpsHost="${currentHttpsHost:-192.168.1.1}"
read -p 'HTTPS host: ' -i "$currentHttpsHost" -e httpsHost
if [[ -z "$httpsHost" ]]; then
	>&2 echo "Host expected"
	exit 1
fi

[[ -f 'sslh.env' ]] && currentHttpsPort="$(grep '^# HTTPS port: ' 'sslh.env' | cut -d' ' -f4)"
currentHttpsPort="${currentHttpsPort:-443}"
read -p 'HTTPS port: ' -i "$currentHttpsPort" -e httpsPort
IsPort "$httpsPort"

[[ -f 'sslh.env' ]] && currentSshHost="$(grep '^# SSH host: ' 'sslh.env' | cut -d' ' -f4)"
currentSshHost="${currentSshHost:-192.168.1.1}"
read -p 'SSH host: ' -i "$currentSshHost" -e sshHost
if [[ -z "$sshHost" ]]; then
	>&2 echo "Host expected"
	exit 1
fi

[[ -f 'sslh.env' ]] && currentSshPort="$(grep '^# SSH port: ' 'sslh.env' | cut -d' ' -f4)"
currentSshPort="${currentSshPort:-22}"
read -p 'SSH port: ' -i "$currentSshPort" -e sshPort
IsPort "$sshPort"

echo

target='docker-compose.yml'
echo "Writing $target..."
cp -f 'docker-compose.template.yml' "$target"

target='sslh.env'
echo "Writing $target..."
echo "# HTTPS host: $httpsHost" > "$target"
echo "# HTTPS port: $httpsPort" >> "$target"
echo >> "$target"
echo "# SSH host: $sshHost" >> "$target"
echo "# SSH port: $sshPort" >> "$target"
echo >> "$target"
echo "SSLH_OPTS=-p 0.0.0.0:443 --ssh $sshHost:$sshPort --tls $httpsHost:$httpsPort" >> "$target"

echo
echo 'Docker Compose configured successfully'
